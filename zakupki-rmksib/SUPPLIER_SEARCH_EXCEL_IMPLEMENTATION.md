# Реализация поиска поставщиков по табличным данным из Excel

## Текущее состояние

Реализована функциональность обработки Excel файлов и поиска поставщиков для каждого товара из таблицы.

## Варианты реализации

### Вариант 1: Последовательный поиск (РЕАЛИЗОВАН) ✅

**Описание:**
- Парсинг Excel файла и извлечение списка товаров
- Последовательный поиск поставщиков для каждого товара
- Отображение прогресса обработки
- Формирование итогового отчета со всеми результатами

**Преимущества:**
- Надежность - каждый товар обрабатывается отдельно
- Возможность отслеживания прогресса
- Легкая обработка ошибок для отдельных товаров
- Понятный пользователю процесс

**Недостатки:**
- Может быть медленным для большого количества товаров
- Много запросов к API (один запрос на товар)

**Когда использовать:**
- Когда нужно показать прогресс пользователю
- Когда важна надежность обработки каждого товара
- Когда количество товаров не очень большое (< 50)

### Вариант 2: Пакетный поиск

**Описание:**
- Парсинг Excel файла и извлечение всех товаров
- Формирование одного запроса к LLM со списком всех товаров
- LLM ищет поставщиков для всех товаров сразу
- Парсинг результата и формирование отчета

**Преимущества:**
- Быстрее для большого количества товаров
- Меньше запросов к API
- Экономия токенов (один запрос вместо многих)

**Недостатки:**
- Сложнее обрабатывать ошибки (если один товар не обработан, весь запрос может провалиться)
- Нет возможности отслеживать прогресс
- Может превысить лимиты токенов для очень больших списков

**Когда использовать:**
- Когда товаров много (> 20)
- Когда важна скорость обработки
- Когда все товары похожи по типу

### Вариант 3: Группированный поиск

**Описание:**
- Парсинг Excel файла и извлечение товаров
- Группировка товаров по категориям/типам (через LLM или эвристики)
- Поиск поставщиков для каждой группы товаров
- Формирование отчета с группировкой

**Преимущества:**
- Оптимизация запросов (меньше запросов, но более релевантные результаты)
- Возможность найти поставщиков, которые могут поставить несколько товаров
- Более структурированный отчет

**Недостатки:**
- Сложнее реализация (нужна логика группировки)
- Может быть менее точным для специфичных товаров

**Когда использовать:**
- Когда товары можно логически сгруппировать
- Когда важно найти поставщиков, которые могут поставить несколько товаров
- Когда нужна более структурированная отчетность

## Текущая реализация (Вариант 1)

### Функции:

1. **`extract_products_from_excel(file_path)`** - парсит Excel файл и извлекает список товаров
   - Ищет заголовки таблицы (Номенклатура, Наименование, Код, Количество)
   - Извлекает товары из строк после заголовка
   - Возвращает список словарей с информацией о товарах

2. **`process_document_upload()`** - обрабатывает загруженный документ
   - Определяет тип файла (Excel, PDF, DOCX)
   - Для Excel: парсит товары напрямую с извлечением единиц измерения
   - Для PDF/DOCX: извлекает текст и использует LLM для извлечения товаров с единицами измерения
   - Для каждого товара ищет поставщиков через Perplexity AI или Sniper Search
   - Парсит контакты (email, телефон) с веб-сайтов поставщиков
   - Группирует поставщиков по email адресам для избежания дубликатов
   - Формирует итоговый отчет с единицами измерения

### Поддерживаемые форматы:

- **Excel (XLSX, XLS)** - прямой парсинг таблицы
- **PDF, DOCX** - извлечение текста + LLM для парсинга товаров

### Структура данных товара:

```python
{
    "name": "Название товара",
    "code": "Код номенклатуры" (опционально),
    "row_number": 15,
    "quantity": "Количество" (опционально, только число),
    "unit": "Единица измерения" (опционально, например: шт., кг., м., л.)
}
```

### Единицы измерения:

Система автоматически определяет единицы измерения товаров:
- **Из отдельного столбца Excel**: поиск столбца с заголовками "единица", "ед.", "единица измерения"
- **Из столбца количества**: автоматическое извлечение единиц из текста (например: "100 шт" → quantity: "100", unit: "шт")
- **Поддерживаемые единицы**: шт, штук, кг, килограмм, г, грамм, т, тонн, м, метр, см, сантиметр, мм, миллиметр, л, литр, мл, миллилитр, м², м³, упак, упаковок, компл, комплект, пар, п.м., пог.м.

### Пример использования:

1. Пользователь загружает Excel файл с перечнем товаров
2. Система парсит файл и находит товары
3. Для каждого товара выполняется поиск поставщиков
4. Формируется отчет со всеми результатами

## Реализованные улучшения (20.11.2025)

1. ✅ **Группировка поставщиков по email** - автоматическое объединение поставщиков с одинаковыми email адресами
2. ✅ **Парсинг контактов с веб-сайтов** - автоматическое извлечение email и телефонов со страниц контактов поставщиков
3. ✅ **Определение единиц измерения** - автоматическое извлечение единиц измерения из Excel и документов
4. ✅ **RFQ генерация** - автоматическое формирование запросов коммерческого предложения с учетом единиц измерения
5. ✅ **Отдельная форма RFQ для документов** - упрощенная форма без кода номенклатуры и технических требований

## Улучшения для будущего

1. **Кэширование результатов** - сохранять результаты поиска для одинаковых товаров
2. **Параллельная обработка** - обрабатывать несколько товаров одновременно (с ограничением на количество параллельных запросов)
3. **Фильтрация дубликатов товаров** - группировать одинаковые товары и искать поставщиков один раз
4. **Экспорт результатов** - возможность экспортировать результаты в Excel/PDF
5. **Сохранение истории** - сохранять результаты поиска в БД для последующего использования
6. **Улучшение парсинга контактов** - использование более продвинутых методов для извлечения контактов

