"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from aiogram.types import Message
from bot.keyboards.reply import get_start_keyboard
from database.models import User
from loguru import logger

router = Router()

# –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
KNOWN_COMMANDS = {
    "üìã –ú–æ–∏ –ª–æ—Ç—ã",
    "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
    "üìÑ –ê–Ω–∞–ª–∏–∑ –ö–ü",
    "üîç –ü–æ–∏—Å–∫ –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤",
    "üöõ –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏",
    "‚ûï –°–æ–∑–¥–∞—Ç—å –ª–æ—Ç",
    "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
    "üöÄ –°—Ç–∞—Ä—Ç",
    "–ü–æ–∏—Å–∫ –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤"
}


@router.message(F.text & ~F.text.in_(KNOWN_COMMANDS) & ~F.text.startswith("/"))  # –ò—Å–∫–ª—é—á–∞–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã, –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "/"
async def unknown_message_handler(message: Message, db_user: User = None, state: FSMContext = None) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –°—Ç–∞—Ä—Ç"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ FSM —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    if state:
        current_state = await state.get_state()
        if current_state is not None:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ FSM —Å–æ—Å—Ç–æ—è–Ω–∏–∏ - –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–¥–µ—Å—å
            # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
            logger.debug(f"User {db_user.id if db_user else 'unknown'} is in FSM state {current_state}, skipping unknown handler")
            return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –°—Ç–∞—Ä—Ç –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    # –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
    # 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤ FSM —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    # 2. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –∏–ª–∏ –∫–Ω–æ–ø–∫–æ–π –º–µ–Ω—é
    # 3. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "/" (–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π)
    # 4. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥—Ä—É–≥–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
    logger.info(f"Unknown message from user {db_user.id if db_user else 'unknown'}: {message.text[:50]}")
    await message.answer(
        "üëã –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –°—Ç–∞—Ä—Ç",
        reply_markup=get_start_keyboard()
    )

