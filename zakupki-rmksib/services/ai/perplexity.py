from __future__ import annotations
import httpx
from typing import Any, Dict, List
from loguru import logger
from config.settings import settings
from database.models import Lot

PERPLEXITY_API_URL = "https://api.perplexity.ai/chat/completions"
# –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ Perplexity (2025):
# - sonar - –±–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞)
# - sonar-pro - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å
# –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ PERPLEXITY_MODEL –≤ .env
def get_default_model() -> str:
	"""–ü–æ–ª—É—á–∏—Ç—å –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
	model = getattr(settings, 'PERPLEXITY_MODEL', 'sonar')
	# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —É—Å—Ç–∞—Ä–µ–≤—à–∞—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º 'sonar'
	if '128k' in model or 'llama-3.1-sonar-large-128k-online' in model:
		logger.warning(f"Obsolete model detected in settings: {model}. Using 'sonar' instead.")
		return 'sonar'
	return model

DEFAULT_MODEL = get_default_model()  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'sonar'


async def ask_perplexity(messages: List[Dict[str, str]], model: str | None = None, temperature: float = 0.2, max_tokens: int | None = 900) -> str:
	if not settings.PERPLEXITY_API_KEY:
		raise RuntimeError("PERPLEXITY_API_KEY is not set in environment")
	
	# –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
	if model is None:
		model = get_default_model()
	
	# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –º–æ–¥–µ–ª—å, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 'sonar'
	if '128k' in model or 'llama-3.1-sonar-large-128k-online' in model:
		logger.warning(f"Obsolete model '{model}' detected. Using 'sonar' instead.")
		model = 'sonar'
	
	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –∫–ª—é—á –Ω–µ –ø—É—Å—Ç–æ–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω
	api_key = settings.PERPLEXITY_API_KEY.strip()
	if not api_key:
		raise RuntimeError("PERPLEXITY_API_KEY is empty")
	
	# Perplexity API –∫–ª—é—á–∏ –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 'pplx-'
	if not api_key.startswith('pplx-'):
		logger.warning(f"Perplexity API key doesn't start with 'pplx-'. Key preview: {api_key[:10]}...")
	
	headers = {
		"Authorization": f"Bearer {api_key}",
		"Content-Type": "application/json",
	}
	
	# –§–æ—Ä–º–∏—Ä—É–µ–º payload - max_tokens –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω –¥–ª—è Perplexity API
	payload: Dict[str, Any] = {
		"model": model,
		"messages": messages,
		"temperature": temperature,
	}
	
	# –î–æ–±–∞–≤–ª—è–µ–º max_tokens —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω –∏ –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
	# –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–æ–¥–µ–ª–µ–π Perplexity max_tokens –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
	if max_tokens is not None:
		if max_tokens > 4096:
			max_tokens = 4096
		if max_tokens < 1:
			max_tokens = 100
		payload["max_tokens"] = max_tokens
	
	# –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
	logger.info(f"Perplexity API request: model={model}, messages_count={len(messages)}, max_tokens={max_tokens}")
	# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
	if '128k' in model:
		logger.error(f"FATAL: Model with 128k detected: {model}. This model is obsolete. Forcing 'sonar'.")
		model = 'sonar'
		payload['model'] = 'sonar'
	
	async with httpx.AsyncClient(timeout=60) as client:
		try:
			resp = await client.post(PERPLEXITY_API_URL, headers=headers, json=payload)
			resp.raise_for_status()
			data = resp.json()
			choices = data.get("choices", [])
			if not choices:
				logger.warning("Perplexity returned no choices")
				return ""
			return choices[0]["message"]["content"]
		except httpx.HTTPStatusError as e:
			# –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
			try:
				error_json = None
				error_text = None
				try:
					error_json = e.response.json()
				except:
					try:
						error_text = e.response.text
					except:
						error_text = str(e)
				
				error_msg = "Unknown error"
				if error_json:
					# Perplexity API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ {'error': {'message': '...'}} –∏–ª–∏ {'message': '...'}
					if isinstance(error_json, dict):
						if 'error' in error_json and isinstance(error_json['error'], dict):
							error_msg = error_json['error'].get('message', str(error_json))
						elif 'message' in error_json:
							error_msg = error_json['message']
						else:
							error_msg = str(error_json)
					else:
						error_msg = str(error_json)
				elif error_text:
					error_msg = error_text
				else:
					error_msg = str(e)
				
				logger.error(f"Perplexity API error {e.response.status_code}: {error_msg}")
				
				# –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ—à–∏–±–∫–∏ 401 (Authorization Required)
				if e.response.status_code == 401:
					logger.error("API key validation failed. Check PERPLEXITY_API_KEY in .env file")
					logger.error(f"API key preview: {api_key[:10]}...{api_key[-4:] if len(api_key) > 14 else '***'}")
					raise RuntimeError(
						f"Perplexity API authorization failed (401). "
						f"Please check your PERPLEXITY_API_KEY in .env file. "
						f"The key should start with 'pplx-' and be valid."
					)
				
				# –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ—à–∏–±–∫–∏ 400 —Å Invalid model
				if e.response.status_code == 400 and "Invalid model" in error_msg:
					logger.error(f"Invalid model '{model}'. Available models: sonar, sonar-pro, llama-3.1-sonar-small-32k-online, llama-3.1-sonar-large-32k-online")
					logger.error("Check PERPLEXITY_MODEL in .env file or update DEFAULT_MODEL in code")
					raise RuntimeError(
						f"Perplexity API invalid model error (400). "
						f"Model '{model}' is not available. "
						f"Use one of: sonar, sonar-pro, llama-3.1-sonar-small-32k-online, llama-3.1-sonar-large-32k-online. "
						f"Set PERPLEXITY_MODEL in .env file."
					)
				
				logger.error(f"Request payload (model, messages count, max_tokens): model={payload.get('model')}, messages={len(payload.get('messages', []))}, max_tokens={payload.get('max_tokens', 'not set')}")
				logger.error(f"Full error response: {error_json if error_json else error_text}")
				# –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
				for i, msg in enumerate(payload.get('messages', [])):
					content_preview = str(msg.get('content', ''))[:500]
					logger.error(f"Message {i} ({msg.get('role')}): {content_preview}...")
				raise RuntimeError(f"Perplexity API error: {e.response.status_code} - {error_msg}")
			except RuntimeError:
				raise
			except Exception as parse_error:
				logger.error(f"Perplexity API error {e.response.status_code}: {str(e)} (parse error: {parse_error})")
				raise RuntimeError(f"Perplexity API error: {e.response.status_code} - {str(e)}")
		except Exception as e:
			logger.error(f"Unexpected error calling Perplexity API: {e}")
			raise


def _lot_to_prompt(lot: Lot, budget_min: int | None = None, budget_max: int | None = None) -> str:
	# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã, –∏–Ω–∞—á–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
	budget_threshold = budget_max if budget_max else settings.BUDGET_THRESHOLD_RUB
	overhead_pct = settings.AI_OVERHEAD_PERCENT
	return (
		f"–ê–Ω–∞–ª–∏–∑ –∑–∞–∫—É–ø–∫–∏:\n"
		f"–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {lot.platform_name}\n"
		f"–ù–æ–º–µ—Ä –ª–æ—Ç–∞: {lot.lot_number}\n"
		f"–ù–∞–∑–≤–∞–Ω–∏–µ: {lot.title}\n"
		f"–ë—é–¥–∂–µ—Ç (‚ÇΩ): {lot.budget}\n"
		f"–î–µ–¥–ª–∞–π–Ω: {lot.deadline}\n"
		f"–°—Ç–∞—Ç—É—Å: {lot.status}\n"
		f"–ó–∞–∫–∞–∑—á–∏–∫: {lot.customer or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
		f"–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞: {', '.join(lot.nomenclature or []) or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n\n"
		f"–û–ø–∏—Å–∞–Ω–∏–µ:\n{lot.description}\n\n"
		"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:"\
		"\n- –ü—Ä–æ–≤–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±—é–¥–∂–µ—Ç–∞ –ø–æ—Ä–æ–≥—É "
		f"{budget_threshold:,} ‚ÇΩ —Å —É—á–µ—Ç–æ–º –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ {overhead_pct}% (–¥–∞–π —Ä–∞—Å—á–µ—Ç)."\
		"\n- –£–∫–∞–∂–∏ –∫–ª—é—á–µ–≤—ã–µ —Ä–∏—Å–∫–∏ –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö —Å–Ω–∏–∂–µ–Ω–∏—è (2-4 –ø—É–Ω–∫—Ç–∞)."\
		"\n- –û–ø—Ä–µ–¥–µ–ª–∏ –≤—ã–≥–æ–¥—ã/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (2-4 –ø—É–Ω–∫—Ç–∞)."\
		"\n- –î–∞–π —á–µ—Ç–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ: —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å/–Ω–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø–æ—á–µ–º—É (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)."\
		"\n- –ü—Ä–µ–¥–ª–æ–∂–∏ 3-5 —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤ (–º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ä–æ—Ç–∫–æ)."\
		"\n–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –∫—Ä–∞—Ç–∫–æ, –ø–æ –ø—É–Ω–∫—Ç–∞–º, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π."
	)


def _lot_to_enhanced_prompt(lot: Lot, budget_min: int | None = None, budget_max: int | None = None) -> str:
	"""–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ"""
	# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã, –∏–Ω–∞—á–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
	budget_threshold = budget_max if budget_max else settings.BUDGET_THRESHOLD_RUB
	overhead_pct = settings.AI_OVERHEAD_PERCENT
	
	# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±—é–¥–∂–µ—Ç —Å –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏
	budget_with_overhead = float(lot.budget) * (1 + overhead_pct / 100)
	
	return (
		f"–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–∫—É–ø–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ:\n\n"
		f"<–î–ê–ù–ù–´–ï –õ–û–¢–ê>\n"
		f"–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {lot.platform_name}\n"
		f"–ù–æ–º–µ—Ä –ª–æ—Ç–∞: {lot.lot_number}\n"
		f"–ù–∞–∑–≤–∞–Ω–∏–µ: {lot.title}\n"
		f"–ó–∞–∫–∞–∑—á–∏–∫: {lot.customer or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
		f"–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞: {', '.join(lot.nomenclature or []) or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
		f"–ë—é–¥–∂–µ—Ç –∑–∞–∫—É–ø–∫–∏ (‚ÇΩ): {lot.budget:,.0f}\n"
		f"–ë—é–¥–∂–µ—Ç —Å –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ {overhead_pct}% (‚ÇΩ): {budget_with_overhead:,.0f}\n"
		f"–î–µ–¥–ª–∞–π–Ω: {lot.deadline}\n"
		f"–°—Ç–∞—Ç—É—Å: {lot.status}\n\n"
		f"–û–ø–∏—Å–∞–Ω–∏–µ:\n{lot.description}\n\n"
		f"</–î–ê–ù–ù–´–ï –õ–û–¢–ê>\n\n"
		f"<–ó–ê–î–ê–ß–ê>\n"
		"–ü—Ä–æ–≤–µ–¥–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ. "
		"–û—Ü–µ–Ω–∏ –∫–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ (0 = –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫/–ø—Ä–æ–±–ª–µ–º–∞, 10 = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫/–ø—Ä–æ–±–ª–µ–º–∞), "
		"–∑–∞—Ç–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞.\n\n"
		f"</–ó–ê–î–ê–ß–ê>\n\n"
		f"<–ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –û–¶–ï–ù–ö–ò>\n\n"
		f"1. –†–ï–î–ö–û–°–¢–¨/–ù–ò–®–ï–í–û–°–¢–¨ –¢–û–í–ê–†–ê (0-10):\n"
		"   –û—Ü–µ–Ω–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–¥–∫–∏–π –∏–ª–∏ –Ω–∏—à–µ–≤—ã–π —Ç–æ–≤–∞—Ä. "
		"–†–µ–¥–∫–∏–µ/–Ω–∏—à–µ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã —Å–ª–æ–∂–Ω–µ–µ –Ω–∞–π—Ç–∏, –≤—ã—à–µ —Ä–∏—Å–∫–∏ —Å –ø–æ—Å—Ç–∞–≤–∫–æ–π.\n"
		"   –§–æ—Ä–º–∞—Ç: '–†–µ–¥–∫–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"2. –†–ò–°–ö–ò –°–ê–ù–ö–¶–ò–ô (0-10):\n"
		"   –û—Ü–µ–Ω–∏ —Ä–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–∞–Ω–∫—Ü–∏—è–º–∏ —Å—Ç—Ä–∞–Ω –ï–≤—Ä–æ–ø–µ–π—Å–∫–æ–≥–æ —Å–æ—é–∑–∞ –∏ —Å—Ç—Ä–∞–Ω, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö —ç—Ç–∏ —Å–∞–Ω–∫—Ü–∏–∏. "
		"–ü—Ä–æ–≤–µ—Ä—å, –º–æ–∂–µ—Ç –ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–ø–∞–¥–∞—Ç—å –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, "
		"–µ—Å—Ç—å –ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç, –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏ –∏–∑-–∑–∞ —Å–∞–Ω–∫—Ü–∏–π.\n"
		"   –§–æ—Ä–º–∞—Ç: '–†–∏—Å–∫–∏ —Å–∞–Ω–∫—Ü–∏–π: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"3. –ü–†–ï–í–´–®–ï–ù–ò–ï –ë–Æ–î–ñ–ï–¢–ê (0-10):\n"
		"   –û—Ü–µ–Ω–∏, –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ –±—é–¥–∂–µ—Ç –∑–∞–∫—É–ø–∫–∏ (—Å —É—á–µ—Ç–æ–º –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ {overhead_pct}%) "
		f"—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ {budget_threshold:,} ‚ÇΩ. "
		f"{f'–¢–∞–∫–∂–µ —É—á—Ç–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ {budget_min:,} ‚ÇΩ - –µ—Å–ª–∏ –±—é–¥–∂–µ—Ç –Ω–∏–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ, —ç—Ç–æ —Ç–æ–∂–µ —Ä–∏—Å–∫.\n' if budget_min else ''}"
		"–£—á—Ç–∏ —Å—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤ –∑–∞—è–≤–∫–µ. "
		"–ï—Å–ª–∏ –±—é–¥–∂–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –∏–ª–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ - —ç—Ç–æ –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫.\n"
		"   –§–æ—Ä–º–∞—Ç: '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å —Ä–∞—Å—á–µ—Ç–æ–º]'\n\n"
		f"4. –î–†–£–ì–ò–ï –°–£–©–ï–°–¢–í–ï–ù–ù–´–ï –§–ê–ö–¢–û–†–´ (0-10):\n"
		"   –û—Ü–µ–Ω–∏ –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã: —Å—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞—á–µ—Å—Ç–≤—É, "
		"—Å–ª–æ–∂–Ω–æ—Å—Ç—å –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —Ä–µ–ø—É—Ç–∞—Ü–∏—è –∑–∞–∫–∞–∑—á–∏–∫–∞, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Å—Ä–µ–¥–∞, "
		"—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ —Ç.–¥.\n"
		"   –§–æ—Ä–º–∞—Ç: '–î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"</–ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –û–¶–ï–ù–ö–ò>\n\n"
		f"<–†–ê–°–ß–ï–¢ –ò–ù–¢–ï–ì–†–ê–õ–¨–ù–û–ô –û–¶–ï–ù–ö–ò –†–ò–°–ö–ê>\n"
		"–†–∞—Å—Å—á–∏—Ç–∞–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:\n"
		"–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ = (–†–µ–¥–∫–æ—Å—Ç—å √ó 0.2) + (–°–∞–Ω–∫—Ü–∏–∏ √ó 0.3) + (–ë—é–¥–∂–µ—Ç √ó 0.3) + (–î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã √ó 0.2)\n"
		"–ì–¥–µ –≤–µ—Å–∞: –°–∞–Ω–∫—Ü–∏–∏ –∏ –ë—é–¥–∂–µ—Ç - –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–ø–æ 0.3), –†–µ–¥–∫–æ—Å—Ç—å –∏ –î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã - –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–ø–æ 0.2).\n"
		"–§–æ—Ä–º–∞—Ç: '–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: X.X/10 - [–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: –Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫]'\n\n"
		f"</–†–ê–°–ß–ï–¢ –ò–ù–¢–ï–ì–†–ê–õ–¨–ù–û–ô –û–¶–ï–ù–ö–ò –†–ò–°–ö–ê>\n\n"
		f"<–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò>\n"
		"–ù–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –¥–∞–π —á–µ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é:\n"
		"- –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å (–µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ ‚â§ 4.0)\n"
		"- –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é (–µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ 4.1-6.0)\n"
		"- –ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å (–µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ > 6.0)\n"
		"–ò –æ–±–æ—Å–Ω—É–π —Ä–µ—à–µ–Ω–∏–µ.\n\n"
		f"</–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò>\n\n"
		f"<–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê>\n"
		"–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:\n\n"
		"üìä –û–¶–ï–ù–ö–ò –ü–û –ü–ê–†–ê–ú–ï–¢–†–ê–ú:\n"
		"1. –†–µ–¥–∫–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n"
		"2. –†–∏—Å–∫–∏ —Å–∞–Ω–∫—Ü–∏–π: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n"
		"3. –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å —Ä–∞—Å—á–µ—Ç–æ–º]\n"
		"4. –î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n\n"
		"üéØ –ò–ù–¢–ï–ì–†–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê –†–ò–°–ö–ê: X.X/10\n"
		"[–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: –Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫]\n\n"
		"‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: [–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å/–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é/–ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å]\n"
		"[–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è]\n\n"
		"üìã –ö–õ–Æ–ß–ï–í–´–ï –†–ò–°–ö–ò:\n"
		"[2-4 –ø—É–Ω–∫—Ç–∞ —Å —Å–ø–æ—Å–æ–±–∞–º–∏ —Å–Ω–∏–∂–µ–Ω–∏—è]\n\n"
		"üí° –í–û–ó–ú–û–ñ–ù–û–°–¢–ò/–í–´–ì–û–î–´:\n"
		"[2-4 –ø—É–Ω–∫—Ç–∞]\n\n"
		"üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:\n"
		"[3-5 –º–∞—Ä–∫–µ—Ä–æ–≤, –∫–æ—Ä–æ—Ç–∫–æ]\n\n"
		f"</–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê>"
	)


async def analyze_lot(lot: Lot, enhanced: bool = True, budget_min: int | None = None, budget_max: int | None = None) -> str:
	"""
	–ê–Ω–∞–ª–∏–∑ –ª–æ—Ç–∞ —á–µ—Ä–µ–∑ Perplexity
	
	Args:
		lot: –û–±—ä–µ–∫—Ç –ª–æ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
		enhanced: –ï—Å–ª–∏ True, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ
		budget_min: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
		budget_max: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
	
	Returns:
		–¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –ª–æ—Ç–∞
	"""
	if enhanced:
		# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –æ—Ü–µ–Ω–∫–∞–º–∏
		messages = [
			{"role": "system", "content": (
				"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–∞–∫—É–ø–∫–∞–º –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏ —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ "
				"–æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤, —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. "
				"–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Ç–æ—á–Ω–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É, "
				"–∏–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ "
				"–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞."
			)},
			{"role": "user", "content": _lot_to_enhanced_prompt(lot, budget_min, budget_max)},
		]
		# –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤
		return await ask_perplexity(messages, max_tokens=2000)
	else:
		# –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
		messages = [
			{"role": "system", "content": (
				"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–∞–∫—É–ø–∫–∞–º –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, "
				"—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ –ø—É–Ω–∫—Ç–∞–º, –∏–∑–±–µ–≥–∞–π –≤–æ–¥—ã."
			)},
			{"role": "user", "content": _lot_to_prompt(lot, budget_min, budget_max)},
		]
		return await ask_perplexity(messages)


async def analyze_documentation(lot: Lot, documentation_text: str, budget_min: int | None = None, budget_max: int | None = None) -> str:
	"""
	–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Perplexity
	
	Args:
		lot: –û–±—ä–µ–∫—Ç –ª–æ—Ç–∞
		documentation_text: –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
		budget_min: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
		budget_max: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
	
	Returns:
		–¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
	"""
	messages = [
		{"role": "system", "content": (
			"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–∞–∫—É–ø–∫–∞–º –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏ —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ "
			"–∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤, —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, "
			"–ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, "
			"—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Ç–æ—á–Ω–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É, –∏–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π. "
			"–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞."
		)},
		{"role": "user", "content": _documentation_to_prompt(lot, documentation_text, budget_min, budget_max)},
	]
	return await ask_perplexity(messages, max_tokens=2500)


def _documentation_to_prompt(lot: Lot, documentation_text: str, budget_min: int | None = None, budget_max: int | None = None) -> str:
	"""–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"""
	# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã, –∏–Ω–∞—á–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
	budget_threshold = budget_max if budget_max else settings.BUDGET_THRESHOLD_RUB
	overhead_pct = settings.AI_OVERHEAD_PERCENT
	
	# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±—é–¥–∂–µ—Ç —Å –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏
	budget_with_overhead = float(lot.budget) * (1 + overhead_pct / 100)
	
	# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤)
	max_doc_length = 10000
	doc_preview = documentation_text[:max_doc_length]
	if len(documentation_text) > max_doc_length:
		doc_preview += f"\n\n[... –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–µ–∑–∞–Ω, –≤—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤: {len(documentation_text)}]"
	
	return (
		f"–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ.\n\n"
		f"–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞ –∑–∞–∫—É–ø–∫–∏ –¥–ª—è –ö–ê–ñ–î–û–ì–û —Ç–æ–≤–∞—Ä–∞ –∏–∑ –ø–µ—Ä–µ—á–Ω—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã.\n"
		f"–†–∞—Å—á—ë—Ç –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Å—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É = –±—é–¥–∂–µ—Ç –ø–æ —Ç–æ–≤–∞—Ä—É.\n"
		f"–û–±—â–∏–π –±—é–¥–∂–µ—Ç = —Å—É–º–º–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤.\n\n"
		f"<–î–ê–ù–ù–´–ï –õ–û–¢–ê>\n"
		f"–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {lot.platform_name}\n"
		f"–ù–æ–º–µ—Ä –ª–æ—Ç–∞: {lot.lot_number}\n"
		f"–ù–∞–∑–≤–∞–Ω–∏–µ: {lot.title}\n"
		f"–ó–∞–∫–∞–∑—á–∏–∫: {lot.customer or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
		f"–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞: {', '.join(lot.nomenclature or []) or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
		f"–ë—é–¥–∂–µ—Ç –∑–∞–∫—É–ø–∫–∏ (‚ÇΩ): {lot.budget:,.0f}\n"
		f"–ë—é–¥–∂–µ—Ç —Å –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ {overhead_pct}% (‚ÇΩ): {budget_with_overhead:,.0f}\n"
		f"–î–µ–¥–ª–∞–π–Ω: {lot.deadline}\n"
		f"–°—Ç–∞—Ç—É—Å: {lot.status}\n\n"
		f"–û–ø–∏—Å–∞–Ω–∏–µ –ª–æ—Ç–∞:\n{lot.description[:500]}\n\n"
		f"</–î–ê–ù–ù–´–ï –õ–û–¢–ê>\n\n"
		f"<–ö–û–ù–ö–£–†–°–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø>\n"
		f"{doc_preview}\n\n"
		f"</–ö–û–ù–ö–£–†–°–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø>\n\n"
		f"<–ó–ê–î–ê–ß–ê>\n"
		"–ü—Ä–æ–≤–µ–¥–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–∏—è. "
		"–ò–∑–≤–ª–µ–∫–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:\n"
		"1. –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ (–µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è, —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)\n"
		"2. –°—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (–≤ —Ä—É–±–ª—è—Ö, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)\n"
		"3. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏\n"
		"4. –£—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å—Ä–æ–∫–∏\n"
		"5. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≥–∞—Ä–∞–Ω—Ç–∏—è–º –∏ —Å–µ—Ä–≤–∏—Å—É\n"
		"6. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –∑–∞—è–≤–æ–∫\n"
		"7. –î—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è\n\n"
		"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –î–ª—è –ö–ê–ñ–î–û–ì–û —Ç–æ–≤–∞—Ä–∞ –∏–∑ –ø–µ—Ä–µ—á–Ω—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –¢–û–ß–ù–û —Ä–∞—Å—Å—á–∏—Ç–∞–π:\n"
		"1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–ø–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)\n"
		"2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ (—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –µ–¥–∏–Ω–∏—Ü–µ–π –∏–∑–º–µ—Ä–µ–Ω–∏—è: —à—Ç, –∫–≥, –º, –º¬≤ –∏ —Ç.–¥.)\n"
		"3. –°—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (–≤ —Ä—É–±–ª—è—Ö, –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–æ—è–±—Ä—å 2025 –≥–æ–¥–∞)\n"
		"4. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –±—é–¥–∂–µ—Ç–∞ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Å—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (–≤ —Ä—É–±–ª—è—Ö)\n\n"
		"–í–ê–ñ–ù–û:\n"
		"- –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –Ω–∞–π–¥–∏ —Å—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n"
		"- –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ\n"
		"- –ï—Å–ª–∏ –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –æ–ø—Ä–µ–¥–µ–ª–∏ –µ—ë –ª–æ–≥–∏—á–µ—Å–∫–∏ (—à—Ç, –∫–≥, –º –∏ —Ç.–¥.)\n"
		"- –†–∞—Å—Å—á–∏—Ç–∞–π –¥–ª—è –í–°–ï–• —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ø–µ—Ä–µ—á–Ω—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã\n"
		"- –û–±—â–∏–π –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç = —Å—É–º–º–∞ —Ä–∞—Å—á—ë—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤\n\n"
		"–ó–∞—Ç–µ–º –æ—Ü–µ–Ω–∏ –∫–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ (0 = –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫/–ø—Ä–æ–±–ª–µ–º–∞, 10 = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫/–ø—Ä–æ–±–ª–µ–º–∞), "
		"–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞.\n\n"
		f"</–ó–ê–î–ê–ß–ê>\n\n"
		f"<–ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –û–¶–ï–ù–ö–ò>\n\n"
		f"1. –†–ï–î–ö–û–°–¢–¨/–ù–ò–®–ï–í–û–°–¢–¨ –¢–û–í–ê–†–ê (0-10):\n"
		"   –û—Ü–µ–Ω–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–¥–∫–∏–π –∏–ª–∏ –Ω–∏—à–µ–≤—ã–π —Ç–æ–≤–∞—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ—á–Ω—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. "
		"–†–µ–¥–∫–∏–µ/–Ω–∏—à–µ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã —Å–ª–æ–∂–Ω–µ–µ –Ω–∞–π—Ç–∏, –≤—ã—à–µ —Ä–∏—Å–∫–∏ —Å –ø–æ—Å—Ç–∞–≤–∫–æ–π.\n"
		"   –§–æ—Ä–º–∞—Ç: '–†–µ–¥–∫–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"2. –†–ò–°–ö–ò –°–ê–ù–ö–¶–ò–ô (0-10):\n"
		"   –û—Ü–µ–Ω–∏ —Ä–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–∞–Ω–∫—Ü–∏—è–º–∏ —Å—Ç—Ä–∞–Ω –ï–≤—Ä–æ–ø–µ–π—Å–∫–æ–≥–æ —Å–æ—é–∑–∞ –∏ —Å—Ç—Ä–∞–Ω, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö —ç—Ç–∏ —Å–∞–Ω–∫—Ü–∏–∏. "
		"–ü—Ä–æ–≤–µ—Ä—å, –º–æ–∂–µ—Ç –ª–∏ —Ç–æ–≤–∞—Ä –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ–ø–∞–¥–∞—Ç—å –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.\n"
		"   –§–æ—Ä–º–∞—Ç: '–†–∏—Å–∫–∏ —Å–∞–Ω–∫—Ü–∏–π: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"3. –ü–†–ï–í–´–®–ï–ù–ò–ï –ë–Æ–î–ñ–ï–¢–ê (0-10):\n"
		"   –û—Ü–µ–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ì–û –†–ê–°–ß–Å–¢–ê –ë–Æ–î–ñ–ï–¢–ê (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Å—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞).\n"
		"   –°—Ä–∞–≤–Ω–∏ —Ä–∞—Å—á—ë—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç —Å:\n"
		f"   - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø–æ—Ä–æ–≥–æ–º –±—é–¥–∂–µ—Ç–∞: {budget_threshold:,} ‚ÇΩ\n"
		f"{f'   - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ø–æ—Ä–æ–≥–æ–º –±—é–¥–∂–µ—Ç–∞: {budget_min:,} ‚ÇΩ\n' if budget_min else ''}"
		f"   - –ë—é–¥–∂–µ—Ç–æ–º –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ({lot.budget:,.0f} ‚ÇΩ)\n"
		f"   - –ë—é–¥–∂–µ—Ç–æ–º —Å –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ {overhead_pct}% ({budget_with_overhead:,.0f} ‚ÇΩ)\n"
		"   –ï—Å–ª–∏ —Ä–∞—Å—á—ë—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –∏–ª–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ - —ç—Ç–æ –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫.\n"
		"   –§–æ—Ä–º–∞—Ç: '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º —Å –ø–æ—Ä–æ–≥–∞–º–∏]'\n\n"
		f"4. –°–õ–û–ñ–ù–û–°–¢–¨ –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –¢–†–ï–ë–û–í–ê–ù–ò–ô (0-10):\n"
		"   –û—Ü–µ–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: "
		"—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –≥–∞—Ä–∞–Ω—Ç–∏–∏, —Å—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏.\n"
		"   –§–æ—Ä–º–∞—Ç: '–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"5. –î–†–£–ì–ò–ï –°–£–©–ï–°–¢–í–ï–ù–ù–´–ï –§–ê–ö–¢–û–†–´ (0-10):\n"
		"   –û—Ü–µ–Ω–∏ –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: "
		"–∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –∑–∞—è–≤–æ–∫, —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã, —à—Ç—Ä–∞—Ñ—ã, —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ —Ç.–¥.\n"
		"   –§–æ—Ä–º–∞—Ç: '–î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã: X/10 - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]'\n\n"
		f"</–ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –û–¶–ï–ù–ö–ò>\n\n"
		f"<–†–ê–°–ß–ï–¢ –ò–ù–¢–ï–ì–†–ê–õ–¨–ù–û–ô –û–¶–ï–ù–ö–ò –†–ò–°–ö–ê>\n"
		"–†–∞—Å—Å—á–∏—Ç–∞–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:\n"
		"–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ = (–†–µ–¥–∫–æ—Å—Ç—å √ó 0.2) + (–°–∞–Ω–∫—Ü–∏–∏ √ó 0.25) + (–ë—é–¥–∂–µ—Ç √ó 0.25) + (–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è √ó 0.15) + (–î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã √ó 0.15)\n"
		"–ì–¥–µ –≤–µ—Å–∞: –°–∞–Ω–∫—Ü–∏–∏ –∏ –ë—é–¥–∂–µ—Ç - –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–ø–æ 0.25), –†–µ–¥–∫–æ—Å—Ç—å (0.2), –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã (–ø–æ 0.15).\n"
		"–§–æ—Ä–º–∞—Ç: '–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: X.X/10 - [–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: –Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫]'\n\n"
		f"</–†–ê–°–ß–ï–¢ –ò–ù–¢–ï–ì–†–ê–õ–¨–ù–û–ô –û–¶–ï–ù–ö–ò –†–ò–°–ö–ê>\n\n"
		f"<–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò>\n"
		"–ù–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –¥–∞–π —á–µ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é:\n"
		"- –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å (–µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ ‚â§ 4.0)\n"
		"- –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é (–µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ 4.1-6.0)\n"
		"- –ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å (–µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ > 6.0)\n"
		"–ò –æ–±–æ—Å–Ω—É–π —Ä–µ—à–µ–Ω–∏–µ.\n\n"
		f"</–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò>\n\n"
		f"<–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê>\n"
		"–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:\n\n"
		f"üìÑ –ò–ó–í–õ–ï–ß–ï–ù–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò–ó –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò:\n"
		f"‚Ä¢ –ü–µ—Ä–µ—á–µ–Ω—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã: [—Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º]\n"
		f"‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: [–∫–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è]\n"
		f"‚Ä¢ –£—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏: [—Å—Ä–æ–∫–∏, –º–µ—Å—Ç–æ, —É—Å–ª–æ–≤–∏—è]\n"
		f"‚Ä¢ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏: [–∫–∞–∫ –±—É–¥—É—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å—Å—è –∑–∞—è–≤–∫–∏]\n"
		f"‚Ä¢ –î—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: [–≥–∞—Ä–∞–Ω—Ç–∏–∏, —à—Ç—Ä–∞—Ñ—ã, —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä –∏ —Ç.–¥.]\n\n"
		f"üí∞ –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –†–ê–°–ß–Å–¢ –ë–Æ–î–ñ–ï–¢–ê –ó–ê–ö–£–ü–ö–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –†–ê–ó–î–ï–õ):\n\n"
		f"–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è. –î–ª—è –ö–ê–ñ–î–û–ì–û —Ç–æ–≤–∞—Ä–∞ –∏–∑ –ø–µ—Ä–µ—á–Ω—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —É–∫–∞–∂–∏:\n\n"
		f"–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞:\n"
		f"<b>–¢–æ–≤–∞—Ä 1: –®–∞–π–±–∞ –ú10</b>\n"
		f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: –®–∞–π–±–∞ –ú10, –æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω–∞—è\n"
		f"‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100 —à—Ç\n"
		f"‚Ä¢ –°—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É: 15.50 ‚ÇΩ\n"
		f"‚Ä¢ –†–∞—Å—á—ë—Ç –±—é–¥–∂–µ—Ç–∞: 100 √ó 15.50 = 1,550 ‚ÇΩ\n\n"
		f"<b>–¢–æ–≤–∞—Ä 2: –®–ø–∏–ª—å–∫–∞ –ú16√ó100</b>\n"
		f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: –®–ø–∏–ª—å–∫–∞ —Ä–µ–∑—å–±–æ–≤–∞—è –ú16√ó100, –æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω–∞—è\n"
		f"‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 50 —à—Ç\n"
		f"‚Ä¢ –°—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É: 45.00 ‚ÇΩ\n"
		f"‚Ä¢ –†–∞—Å—á—ë—Ç –±—é–¥–∂–µ—Ç–∞: 50 √ó 45.00 = 2,250 ‚ÇΩ\n\n"
		f"[–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–∞–∫–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –í–°–ï–• —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ø–µ—Ä–µ—á–Ω—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã]\n\n"
		f"–í–ê–ñ–ù–û:\n"
		f"- –ï—Å–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ\n"
		f"- –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –Ω–∞–π–¥–∏ —Å—Ä–µ–¥–Ω–µ—Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É –Ω–∞ –Ω–æ—è–±—Ä—å 2025 –≥–æ–¥–∞\n"
		f"- –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ –∏ –æ—Ü–µ–Ω–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–∏—á–µ—Å–∫–∏\n"
		f"- –í—ã–ø–æ–ª–Ω–∏ —Ä–∞—Å—á—ë—Ç –¥–ª—è –í–°–ï–• —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π\n\n"
		f"üìä <b>–ò–¢–û–ì–û–í–´–ô –†–ê–°–ß–Å–¢:</b>\n"
		f"‚Ä¢ –û–±—â–∏–π –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç (—Å—É–º–º–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤): [—Ç–æ—á–Ω–∞—è —Å—É–º–º–∞] ‚ÇΩ\n"
		f"‚Ä¢ –ë—é–¥–∂–µ—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: {lot.budget:,.0f} ‚ÇΩ\n"
		f"‚Ä¢ –†–∞–∑–Ω–∏—Ü–∞: [—Ä–∞—Å—á—ë—Ç–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞] ‚ÇΩ ([–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è]%)\n\n"
		f"–í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ —Ç–æ–≤–∞—Ä –Ω–µ –∏–º–µ–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–ª–∏ —Ü–µ–Ω—ã, —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ –∏ –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ç—ã –æ—Ü–µ–Ω–∏–ª –±—é–¥–∂–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.\n\n"
		f"üìä –û–¶–ï–ù–ö–ò –ü–û –ü–ê–†–ê–ú–ï–¢–†–ê–ú:\n"
		f"1. –†–µ–¥–∫–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n"
		f"2. –†–∏—Å–∫–∏ —Å–∞–Ω–∫—Ü–∏–π: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n"
		f"3. –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å —Ä–∞—Å—á–µ—Ç–æ–º]\n"
		f"4. –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n"
		f"5. –î—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã: X/10 - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n\n"
		f"üéØ –ò–ù–¢–ï–ì–†–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê –†–ò–°–ö–ê: X.X/10\n"
		f"[–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: –Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫]\n\n"
		f"‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: [–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å/–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é/–ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å]\n"
		f"[–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è]\n\n"
		f"üìã –ö–õ–Æ–ß–ï–í–´–ï –†–ò–°–ö–ò:\n"
		f"[2-4 –ø—É–Ω–∫—Ç–∞ —Å —Å–ø–æ—Å–æ–±–∞–º–∏ —Å–Ω–∏–∂–µ–Ω–∏—è]\n\n"
		f"üí° –í–û–ó–ú–û–ñ–ù–û–°–¢–ò/–í–´–ì–û–î–´:\n"
		f"[2-4 –ø—É–Ω–∫—Ç–∞]\n\n"
		f"üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:\n"
		f"[3-5 –º–∞—Ä–∫–µ—Ä–æ–≤, –∫–æ—Ä–æ—Ç–∫–æ]\n\n"
		f"</–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê>"
	)


async def search_suppliers_perplexity(product_name: str, max_suppliers: int = 20) -> str:
	"""
	Search for suppliers using Perplexity AI with real contact parsing
	
	Args:
		product_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
		max_suppliers: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)
	
	Returns:
		–¢–µ–∫—Å—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
	"""
	import re
	from services.suppliers.contact_parser import get_supplier_contacts
	
	# –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
	clean_product_name = product_name.strip()[:200]
	
	# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç - –ø—Ä–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Å–∞–π—Ç—ã, –ë–ï–ó –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
	user_prompt = (
		f"–ù–∞–π–¥–∏ {max_suppliers} —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–∞: {clean_product_name}\n\n"
		"–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:\n"
		f"- –ù–∞–π–¥–∏ {max_suppliers} –∫–æ–º–ø–∞–Ω–∏–π\n"
		"- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–≤–∞–π –∫–æ–º–ø–∞–Ω–∏—è–º —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ –≤–µ–±-—Å–∞–π—Ç–∞–º–∏\n"
		"- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã (email, —Ç–µ–ª–µ—Ñ–æ–Ω—ã) - —É–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –Ω–∞–π–¥–µ–Ω–æ\n\n"
		"–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —É–∫–∞–∂–∏ –¢–û–õ–¨–ö–û:\n"
		"  1. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–ø–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ)\n"
		"  2. –í–µ–±-—Å–∞–π—Ç (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)\n"
		"  3. –ì–æ—Ä–æ–¥/—Ä–µ–≥–∏–æ–Ω (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)\n"
		"  4. –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏)\n\n"
		"–í–ê–ñ–ù–û: –ù–ï —É–∫–∞–∑—ã–≤–∞–π email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö!\n"
		"–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
		"1. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ | –°–∞–π—Ç: https://example.com | –ì–æ—Ä–æ–¥: –ú–æ—Å–∫–≤–∞ | –ò–ù–ù: 1234567890"
	)
	
	max_tokens = 2000
	messages = [
		{"role": "system", "content": (
			f"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–∏—Å–∫—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –†–æ—Å—Å–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ {max_suppliers} –∫–æ–º–ø–∞–Ω–∏–π "
			"–¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞. –í–ê–ñ–ù–û: —É–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. "
			"–ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã (email, —Ç–µ–ª–µ—Ñ–æ–Ω—ã). –£–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è, —Å–∞–π—Ç—ã, –≥–æ—Ä–æ–¥–∞ –∏ –ò–ù–ù. "
			"–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ –ø—É–Ω–∫—Ç–∞–º."
		)},
		{"role": "user", "content": user_prompt},
	]
	
	# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –æ—Ç Perplexity
	perplexity_result = await ask_perplexity(messages, max_tokens=max_tokens)
	
	# –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —Å–∞–π—Ç—ã
	suppliers_data = []
	lines = perplexity_result.split('\n')
	
	for line in lines:
		line = line.strip()
		if not line or not re.match(r'^\d+\.', line):
			continue
		
		# –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–∞–π—Ç
		# –§–æ—Ä–º–∞—Ç: "1. –ù–∞–∑–≤–∞–Ω–∏–µ | –°–∞–π—Ç: https://... | –ì–æ—Ä–æ–¥: ... | –ò–ù–ù: ..."
		name_match = re.search(r'^\d+\.\s*(.+?)(?:\s*\||$)', line)
		website_match = re.search(r'[–°—Å]–∞–π—Ç[:\s]+(https?://[^\s|]+)', line)
		city_match = re.search(r'[–ì–≥]–æ—Ä–æ–¥[:\s]+([^\s|]+)', line)
		inn_match = re.search(r'–ò–ù–ù[:\s]+(\d+)', line)
		
		if name_match:
			supplier_name = name_match.group(1).strip()
			website = website_match.group(1) if website_match else None
			city = city_match.group(1) if city_match else None
			inn = inn_match.group(1) if inn_match else None
			
			if supplier_name:
				suppliers_data.append({
					'name': supplier_name,
					'website': website,
					'city': city,
					'inn': inn,
					'original_line': line
				})
	
	# –ü–∞—Ä—Å–∏–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —Å —Å–∞–π—Ç–æ–º
	result_lines = []
	logger.info(f"Found {len(suppliers_data)} suppliers from Perplexity, parsing contacts...")
	
	for idx, supplier in enumerate(suppliers_data[:max_suppliers], 1):
		name = supplier['name']
		website = supplier['website']
		city = supplier.get('city', '')
		inn = supplier.get('inn', '')
		
		result_line = f"{idx}. <b>{name}</b>\n"
		
		if website:
			result_line += f"   üåê –°–∞–π—Ç: {website}\n"
			
			# –ü–∞—Ä—Å–∏–º –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å —Å–∞–π—Ç–∞
			logger.info(f"Parsing contacts for {name} from {website}")
			try:
				contacts = await get_supplier_contacts(name, website)
				
				if contacts.get('emails'):
					emails = contacts['emails'][:2]  # –ú–∞–∫—Å–∏–º—É–º 2 email
					result_line += f"   üìß Email: {', '.join(emails)}\n"
					logger.info(f"Found {len(emails)} emails for {name}")
				else:
					result_line += f"   üìß Email: –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–∞–π—Ç–µ\n"
					logger.warning(f"No emails found for {name} on {website}")
				
				if contacts.get('phones'):
					phones = contacts['phones'][:2]  # –ú–∞–∫—Å–∏–º—É–º 2 —Ç–µ–ª–µ—Ñ–æ–Ω–∞
					result_line += f"   üì± –¢–µ–ª–µ—Ñ–æ–Ω: {', '.join(phones)}\n"
					logger.info(f"Found {len(phones)} phones for {name}")
				else:
					result_line += f"   üì± –¢–µ–ª–µ—Ñ–æ–Ω: –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–∞–π—Ç–µ\n"
					logger.warning(f"No phones found for {name} on {website}")
				
				if contacts.get('address'):
					address = contacts['address'][:100]
					result_line += f"   üìç –ê–¥—Ä–µ—Å: {address}\n"
			except Exception as e:
				logger.error(f"Error parsing contacts for {name} ({website}): {e}", exc_info=True)
				result_line += f"   üìß Email: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å —Å–∞–π—Ç–∞\n"
				result_line += f"   üì± –¢–µ–ª–µ—Ñ–æ–Ω: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å —Å–∞–π—Ç–∞\n"
		else:
			result_line += f"   üåê –°–∞–π—Ç: –Ω–µ —É–∫–∞–∑–∞–Ω\n"
			result_line += f"   üìß Email: –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç —Å–∞–π—Ç–∞)\n"
			result_line += f"   üì± –¢–µ–ª–µ—Ñ–æ–Ω: –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç —Å–∞–π—Ç–∞)\n"
			logger.warning(f"No website for {name}, skipping contact parsing")
		
		if city:
			result_line += f"   üèô –ì–æ—Ä–æ–¥: {city}\n"
		if inn:
			result_line += f"   üÜî –ò–ù–ù: {inn}\n"
		
		result_lines.append(result_line)
	
	if not result_lines:
		return (
			f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–∞: {product_name}\n\n"
			"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
			"- –£—Ç–æ—á–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\n"
			"- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –æ–±—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\n"
			"- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è"
		)
	
	return "\n\n".join(result_lines)
